---
title: 3.1 数据备份与恢复

categories:
- MySQL教程

date: 2020-03-09 00:00:01
---


#### 测试

## 全量备份与增量备份
### 全量备份
全量数据就是数据库中所有的数据，全量备份就是把数据库中所有的数据进行备份。
```bash
# 备份一个库
mysqldump 
mysqldump -uroot -poldbody -S /data/33-6/mysql.sock -F -B oldbody|gzip > /server/backup/mysqlbak_$(data +%F).sql.gz

# 备份所有库
mysqldump -uroot -poldbody -S /data/33-6/mysql.sock -F -B -A|gzip > /server/backup/mysqlbak_$(data +%F).sql.gz
```

### 增量备份
增量数据就是从上次全量备份之后，更新的新数据。对于MySQL来说，binlog日志就是MySQL的增量数据。

#### 按天备份情况
优点：
1. 恢复时间短
1. 维护成本低

缺点：
1. 占用空间多
1. 占用资源多，经常锁表操作

|周一全量备份|周一增量数据|周一全量备份|周二增量数据|...|
|:--|
|000000001.sql.gz|mysql-bin.000036|000000002.sql.gz|mysql-bin.000056|
||mysql-bin.000037||mysql-bin.000057|
||mysql-bin.000038||mysql-bin.000058|
||mysql-bin.000039||mysql-bin.000059|




#### 按周备份情况
优点：
1. 占用空间小
1. 占用资源少，无需经常锁表，用户体验会好点

缺点：
1. 维护成本大，恢复麻烦

|周六全量备份|周一增量备份|周二增量备份|周三增量备份|...|
|:--|
|000000001.sql.gz|mysql-bin.000037|mysql-bin.000037|mysql-bin.000037||

#### 全量和增量的频率是怎么做的呢？
1. 中小公司，全量一般是每天一次，业务流量低谷执行全备，执行前要锁表
1. 单台数据库，如何增量。用rsync（配合定时任务频率大点，或者inotify，主从复制）把所有binlog备份到远程服务器，尽量做主从复制
1. 大公司周备，每周六00点一次全量，下周日-下周六00点前都是增量
1. 一主多从，会有一个从库做备份，延迟同步

#### mysql的mysqldump备份什么时候能派上用场？ 
1. 迁移或者升级数据库时
1. 增加从库的时候
1. 因为硬件或特殊异常情况，主库或者从库挂机，主从可以相互切换，无需备份
1. 人为的DDL，DML语句，主从库没办法了，所有库都会执行。此时需要备份
1. 跨机房灾备，需要备份拷贝走

增量备份例子：
```bash
rsync -avz /data/3306/mysql-bin.000* rsync_backup@10.0.0.18::backup --password-file=/etc/rsync.password
```

#### 什么情况下需要增量恢复？
我们在生产工作中一般常用一主多从的数据库架构，常见的备份方案是在某一不对外服务的从库上开启binlog，然后实施定时全备份和实时增量备份

#### 什么是增量恢复
利用二进制日志和全备进行的恢复国产，被称为增量恢复

#### 主或从库宕机（硬件损坏）是否需要增量恢复？
不要增量恢复，主库宕机，只需要把其中一个同步最快的从库（master.info，或5.5半同步机制）切换为主库即可。从库宕机，直接不用就好了（一般会配LVS负载均衡）， 或者正常修复。

#### 人为操作数据库SQL破坏主库是否需要增量恢复？
在数据库主库内部命令行误操作，会导致所有的数据库（包括从库）数据丢失，例如：在主库里执行了drop database test;这样的删除语句，这是所有的从库也会执行这个drop database test;语句，从而导致所有的数据库的test库丢死后。这样的场景是需要增量恢复的。

#### 只有一个主库是否需要增量恢复？
如果公司里只有一个主库的情况，首先应该做定时全量备份（每天一次）及增量备份（每个1-10分钟对binlog日志做切割然后备份到其它的服务器上，或者本地其它的硬盘里）或者些到网络文件系统（备份服务器）里。

如果不允许数据丢失，最好的办法就是做从库，通过drbd（基于磁盘块的）同步。

正常情况：
1. 主从同步：除了分担读写分离压力外，还可以防止物理设置损坏数据丢失的恢复
1. 从库备份：在从库进行全量和增量方式的备份，可以防止人为对主库的误操作导致数据丢失，确保备份的从库实时和主库是同步状态的

> 小结
> 一般由人为（或程序）逻辑的方式在数据库执行的SQL语句等误操作，需要增量恢复，因为此时，所有的从库也执行了误操作语句。

## MySQL增量恢复必备条件
### 开启log-bin日志功能
MySQL数据库开启log-bin参数记录binlog日志功能如下：
```bash
grep log-bin /data/3306/my.cnf
log-bin=/data/3306/mysql-bin
```

提示：主库和备份的从库都要开启binlog记录功能

> 小结
> 存在一份全备份加上全备之后的时刻到问题时刻的所有增量binlog文件备份


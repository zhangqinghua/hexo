---
title: MySQL 事务机制

categories:
- MySQL 手册

date: 2020-07-07 00:00:05
---

## 隔离级别

## MVCC 机制
1. 定义
   MVCC 是一种并发控制机制，在数据库中用来控制并发执行的事务，控制事务隔离进行。

1. 核心思想
   MVCC 是通过保存数据在某个时间点的快照来进行控制的。使用MVCC就是允许同一个数据记录拥有多个不同的版本。然后在查询时通过添加相对应的约束条件，就可以获取用户想要的对应版本的数据。

1. 解决什么
   MVCC 主要是为了提供并发的读写性能，不用加锁就能让多个事务并发读写。在读多写少的场景中，读写不冲突是非常重要的，极大的增加了系统的并发性能。

1. 适用条件
   MVCC 只适用于 MySQL 隔离级别中的读已提交和可重复读。

#### 隐藏列
在 Innodb 中，每一行记录都有两个隐藏列：DATA_ITR_ID、DATA_ROLL_PTR。

1. DATA_TRX_ID
   记录最近更新这条行记录的事务 ID，大小为 6 个字节。

1. DATA_ROLL_PTR
   表示指向该行回滚段的指针，大小为 7 个字节，InnoDB 便是通过这个指针找到之前版本的数据。该行记录上所有旧版本，在 undo 中都通过链表的形式组织。

1. DB_ROW_ID
   行标识（隐藏单调自增 ID），大小为 6 字节，如果表没有主键，InnoDB 会自动生成一个隐藏主键，因此会出现这个列。另外，每条记录的头信息里都有一个专门的 bit 来表示当前记录是否已经被删除。

![](https://pic2.zhimg.com/80/v2-f25ed246387e60fbeb5b7ec9ed9028b1_720w.jpg)

#### undo log
记录数据各版本修改历史即事务链。在多个事务并行操作某行数据的情况下，不同事务对该行数据的修改会产生多个版本，然后通过回滚指针组织成一条 undo Log 链。

![](https://pic4.zhimg.com/80/v2-759e2202ee64b45fb4bc8cdea640c813_720w.jpg)

#### readview
即读视图，用于判断哪些版本对当前事务可见。它由最小事务 Id，未提交事务 Id 数组，最大事务 Id 组成。例如：100|[105, 108, 200]|200。

对于当前事务来说，这些事务都是可见的：
1. 事务 Id 等于当前事务 Id。
1. 事务 Id 不在未提交的事务数组中。

如果当前事务多次查询记录，而期间记录由事务提交了，则不同行为的 readview 查询的结果也不一样。
1. 读未提交情况下，记录的事务提交了，readview 重新获取。则当前事务读取到了提交的事务记录。
1. 读已提交情况下，记录的事务提交了，readview 沿用旧的。则当前事务无法读取到了提交的事务记录。

#### 举例说明
1. 事务 1 插入了数据 {id=101, age = 11, trx_id = 1}。
1. 事务 2 修改了数据 {id=101, age = 12, trx_id = 2}。事务 A 的数据转移到 undo log 里，事务 B 的数据执向 事务 A 的数据。
1. 事务 2 提交了数据。
1. 事务 3 修改了数据 {id=101, age = 13, trx_id = 3}。事务 B 的数据转移到 undo log 里，事务 C 的数据执向 事务 B 的数据。
1. 事务 4 修改了数据 {id=101, age = 14, trx_id = 4}。事务 C 的数据转移到 undo log 里，事务 D 的数据执向 事务 C 的数据。
1. 事务 1 查看了数据，根据 readview {1, 3, 4} 规则，在 undo log 里面找到了 {id=101, age = 11, trx_id = 1}。
1. 事务 5 查看了数据，根据 readview {1, 3, 4} 规则，在 undo log 里面找到了 {id=101, age = 13, trx_id = 2}。
1. 事务 3 提交了数据。
1. 事务 5 查看了数据，读未提交隔离级别，review {1, 4} 变化，在 undo log 里面找到了 {id=101, age = 13, trx_id = 3}。
1. 事务 5 查看了数据，读已提交隔离级别，review {1, 3, 4} 不变，在 undo log 里面找到了 {id=101, age = 13, trx_id = 2}。















## 问题
1. 事务四大特性
1. 事务的二段提交机制？
1. MySQL 支持事务吗
1. 事务的ACID（原子性、一致性、隔离性、持久性）
1. InnoDB 支持的四种事务隔离级别名称，以及逐级之间的区别
1. 数据库中的事务是什么
1. MySQL 中的事务回滚机制概述
1. 事务隔离级别和各自存在的问题（脏读、不可重复读、幻读）和解决方式（间隙锁及MVCC）
1. 数据库事务属性
1. MySQL 事务隔离级别以及 MVCC 机制
1. MySQL 的事务隔离级别，分别解决什么问题？
1. 什么是幻读，如何解决
1. 事务隔离级别有什么？通过什么来实现的？分别解决了什么问题？
1. MySQL 的事务隔离级别，分别解决什么问题。
1. 谈谈事务的ACID
1. 数据库的事务，四个性质说一下，分别有什么用，怎么实现的？
1. 事务隔离级别
1. 不可重复度和幻读，怎么避免，底层怎么实现（行锁表锁）
1. ACID CAP BASE理论，以及RPC过程。
1. MySQL事务讲一下，事务定义，四个性质，事务并发引起的问题，事务的四个隔离级别
1. 数据库隔离级别 脏读 幻读 ACID MySQL的隔离级别
1. 讲一下数据库的隔离等级
1. 隔离级别，依次解决的问题（脏读、不可重复读、幻读）
1. 事务的ACID
1. Redis 和数据库如何保证数据一致性